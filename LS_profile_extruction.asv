function obj = LS_profile_extruction(obj,varargin)
%   Description
%   obj = LS_profile_extruction(obj)                -   extract profile
%   obj = LS_profile_extruction(obj,'save_flag',1)  -   extract and save
%%  ä¾èµ–å…³ç³»åˆ¤æ–­
if obj.syset.flags.read_flag_sdgrou~=1
    error('skeleton_extraction has not been processed yet!')
end
%%  default values
default_save_flag = 0;
default_ver = 2;            % æ›²çº¿ç¦»æ•£åŒ–è®¡ç®—æ¨¡å¼é€‰æ‹©
default_fit_mode = 1;       % % æ‹Ÿåˆæ¨¡å¼ï¼Œ1.ç›´æ¥æ‹Ÿåˆy=f(x) 2.å‚æ•°åŒ–æ‹Ÿåˆx=f(t),y=f(t)
%   å£°æ˜ä¸€ä¸ªpä¸ºinputParseræ ¼å¼çš„ã€‚å…¶å®ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¯¥æ ¼å¼çš„å¥æŸ„ä¸€æ ·çš„ä¸œè¥¿
IP = inputParser;
addRequired(IP,'obj');
%   æ¥ä¸‹æ¥ä¸¤ä¸ªæ˜¯å¯é€‰å‚æ•°ï¼Œåå­—åˆ†åˆ«ä¸ºâ€™stepsize'å’Œ'OptimalityTolerance'ï¼Œå¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°è¾“å…¥å°†æœ‰ç›¸åº”çš„ç¼ºçœå€¼defaulthå’Œepsilonã€‚è¿™äº›éƒ½åœ¨å‡½æ•°å¼€å¤´å£°æ˜å¥½äº†
addParameter(IP,'save_flag',default_save_flag);
addParameter(IP,'ver',default_ver);
addParameter(IP,'fit_mode',default_fit_mode);
%   åˆ©ç”¨parseå‡½æ•°å°†è¾“å…¥å‚æ•°ä¸ä¸Šé¢çš„è¿›è¡ŒåŒ¹é…
parse(IP,obj,varargin{:});
%   æ­¤æ—¶å°±å·²ç»ç”Ÿæˆå¥½äº†ä¸€ä¸ªinputParseræ ¼å¼çš„å‚æ•°pï¼Œpé‡Œé¢å«æœ‰ä¸å°‘ä¸œè¥¿ï¼Œå…¶ä¸­å®ƒçš„Resultsä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œæ˜¯è¾“å…¥å‚æ•°åœ¨åŒ¹é…åçš„å€¼ï¼Œåˆ©ç”¨è¿™ä¸ªå¯ä»¥å®Œæˆæˆ‘çš„outputçš„èµ‹å€¼
save_flag = IP.Results.save_flag;
ver = IP.Results.ver;
fit_mode = IP.Results.fit_mode;
%%  å¤„ç†ç¨‹åº
test  = 1;
debug = 1;
factor= 1.2;
%   åŸºæœ¬æ€è·¯ï¼š
%   (1)è¯»å–åˆ†ç»„ä¿¡æ¯ï¼›(2)è·å–çº¿æ¡ä¸­å¿ƒçº¿æ³•çŸ¢é‡ï¼Œç”Ÿæˆæ³•å¹³é¢æ–¹ç¨‹fnï¼›(3)æ±‚æ³•å¹³é¢ä¸çº¿æ¡æ–¹ç¨‹çš„äº¤çº¿cï¼Œå–cä¸­å¤§äºzregçš„éƒ¨åˆ†ä½œä¸ºçº¿æ¡æˆªé¢
%   ç„¶åå†åœ¨æˆªé¢åˆ†æä¸­ï¼š
%   (1)åˆ†ææˆªé¢å®½åº¦é«˜åº¦å³å¯ã€‚
c = obj.Devinfo.inplt;
m= 1;
s= 0;
previousposition=[0 0 0];
current_position=[0 0 0];
ts=0;
for i=1:length(obj.LS_Vox) % å¯¹æ¯ä¸€ç»„çº¿æ¡
    switch fit_mode
        case 1
            curve = obj.LS_Vox(i).curve;    % è¯»å–çº¿æ¡è½¨è¿¹
            cfunc = curve.curve_model;      % è¯»å–è½¨è¿¹å‡½æ•°
        case 2
            curvex= obj.LS_Vox(i).curve_x;  % è¯»å–çº¿æ¡è½¨è¿¹
            curvey= obj.LS_Vox(i).curve_y;  % è¯»å–çº¿æ¡è½¨è¿¹
            xfunc = curvex.curve_model;     % è¯»å–è½¨è¿¹å‡½æ•°
            yfunc = curvey.curve_model;     % è¯»å–è½¨è¿¹å‡½æ•°
    end
    edge  = obj.LS_Vox(i).edge;     % è¯»å–æ›²é¢è¾¹ç•Œ
    ssurf = obj.LS_Vox(i).function; % è¯»å–æ›²é¢å‡½æ•°
    zreg  = obj.PC_data_merged.group_data.reg;
    % ver = 1; %æ›²çº¿ç¦»æ•£åŒ–è®¡ç®—
    switch ver
        case 1 % Xæ–¹å‘ç¦»æ•£
            switch fit_mode
                case 1
                    xcurve = (curve.controlpoints(1,1):c*curve.curve_dir:curve.controlpoints(end,7))';
                    ycurve = cfunc(xcurve);
                    scurve = [0;vecnorm([xcurve(2:end)-xcurve(1:end-1),ycurve(2:end)-ycurve(1:end-1)]',2)'];
                case 2
                    tcurve=0:c*1e-3:1;
                    xcurve = xfunc(tcurve);
                    ycurve = yfunc(tcurve);
                    scurve = [0;vecnorm([xcurve(2:end)-xcurve(1:end-1),ycurve(2:end)-ycurve(1:end-1)]',2)'];
            end
        case 2 % è·¯å¾„æ–¹å‘ç¦»æ•£
            switch fit_mode
                case 1
                    xcurve=curve.controlpoints(1,1);
                    ycurve=cfunc(curve.controlpoints(1,1));
                    scurve=0;
                    num=1;
                    while 1
                        tempx = (xcurve(num):c*1e-2*curve.curve_dir:curve.controlpoints(end,7))';
                        sn = find(vecnorm(([tempx-xcurve(num),cfunc(tempx)-cfunc(xcurve(num))])',2)-c>=0,1,"first");
                        if isempty(sn)
                            distance = norm((xcurve(num)-curve.controlpoints(end,7)),(cfunc(xcurve(num))-cfunc(curve.controlpoints(end,7))));
                            if distance>=0.5*c
                                xcurve(num+1)=curve.controlpoints(end,7);
                                ycurve(num+1)=cfunc(curve.controlpoints(end,7));
                                scurve(num+1)=distance;
                            end
                            break
                        else
                            xcurve(num+1)=tempx(sn);
                            ycurve(num+1)=cfunc(tempx(sn));
                            scurve(num+1)=c;
                            num=num+1;
                        end
                    end
                case 2
                    tcurve=0:c*1e-4:1;
                    xcurve=xfunc(tcurve);xcurve=reshape(xcurve,[],1);
                    ycurve=yfunc(tcurve);ycurve=reshape(ycurve,[],1);
                    xy=[xcurve,ycurve];
                    temps=[0;vecnorm([xy(2:end,:)-xy(1:end-1,:)]',2)'];
                    s=zeros(size(temps));
                    pool=parpool(2);
                    parfor j=1:length(temps); s(j)=sum(temps(1:j)); end
                    starg= [0:c*1e-1:s(end)];
                    sns  = NaN(size(starg));
                    parfor j=1:length(starg)
                        temp1=abs(s-starg(j));
                        [temp2,idt]=sort(temp1);
                        temp3=find(temp2>0,1,"first");
                        temp4=idt(temp3);
                        sns(j)=temp4;
                    end
                    pool = gcp('nocreate');
                    delete(pool);
                    tcurve=tcurve(sns);
                    xcurve=xcurve(sns);
                    ycurve=ycurve(sns);
                    scurve=s(sns);
                    tcurve=reshape(tcurve,[],1);
            end
    end
    xcurve = reshape(xcurve,[],1);
    ycurve = reshape(ycurve,[],1);
    scurve = reshape(scurve,[],1);
    % obj.obj.LS_Vox(i).xcurve=xcurve;
    % obj.obj.LS_Vox(i).ycurve=ycurve;
    if debug
        plot(xcurve,ycurve,'k.');
    end
    switch fit_mode
        case 1
            % vect2 = [curve.controlpoints(:,1:4);curve.controlpoints(end,[7,8,5,6])];                  % æ„å»ºäºŒç»´åˆ‡å‘å‘é‡
            % vect2(:,3:4) = vect2(:,3:4)./vecnorm((vect2(:,3:4))',2);                                  % å‘é‡æ ‡å‡†åŒ–
            vecvec= [   2e-1*c*curve.curve_dir*ones(size(xcurve)),...
                cfunc(xcurve+1e-1*c*curve.curve_dir)-cfunc(xcurve-1e-1*c*curve.curve_dir)];
        case 2
            vecvec= [ xfunc(tcurve+c*1e-4)-xfunc(tcurve-c*1e-4),yfunc(tcurve+c*1e-4)-yfunc(tcurve-c*1e-4)];
    end
    vecvec= vecvec./vecnorm(vecvec',2)';
    vect2 = [xcurve,ycurve,vecvec];
    vect3 = [vect2(:,[1,2]),zeros(size(vect2(:,1))),vect2(:,[3,4]),zeros(size(vect2(:,1)))];    % æ„å»ºä¸‰ç»´åˆ‡å‘å‘é‡
    % è¿™é‡Œåªæ˜¯å¾ˆç®€å•çš„ï¼Œå¦‚æœé¢å¯¹ç©ºé—´çº¿æ¡ï¼Œéœ€è¦å¯¹è¿™è¡ŒğŸ‘†åšä¿®æ”¹
    % æ„å»ºæ‰€æœ‰æ³•å¹³é¢æ–¹ç¨‹ Ax+By+Cz+D=0;
    A = vect3(:,4); B = vect3(:,5); C = vect3(:,6);
    D = -(A.*vect3(:,1)+B.*vect3(:,2)+C.*vect3(:,3));
    cc = c/10;                      % ç¦»æ•£åŒ–æ›²é¢
    x = edge(1):cc:edge(2); y = edge(3):cc:edge(4); % æ„å»ºæ•£ç‚¹
    [xx,yy]=meshgrid(x,y);
    zz = ssurf(xx,yy);
    x1 = reshape(xx,[],1); y1 = reshape(yy,[],1); z1 = reshape(zz,[],1);
    for j=1:length(A) % å¯¹æ¯ä¸ªæ³•å¹³é¢
        ts=ts+scurve(j);
        %   è®¡ç®—æ›²é¢ä¸Šæ¯ä¸ªç‚¹åˆ°æ³•å¹³é¢çš„è·ç¦» d = d0/d1
        d0 = A(j)*x1+B(j)*y1+C(j)*z1+D(j);
        d1 = abs(d0)./(A(j)^2+B(j)^2+C(j)^2);
        % sn = find(d1<factor*c & z1>zreg);       % æ‰¾åˆ°è·ç¦»å°äºcä¸”é«˜åº¦å¤§äºzregçš„ç‚¹ï¼Œè®¤ä¸ºè¿™äº›ç‚¹æ˜¯äº¤çº¿
        sn = find(d1<factor*c);       % æ‰¾åˆ°è·ç¦»å°äºcä¸”é«˜åº¦å¤§äºzregçš„ç‚¹ï¼Œè®¤ä¸ºè¿™äº›ç‚¹æ˜¯äº¤çº¿
        x2 = x1(sn); y2 = y1(sn); z2 = z1(sn);
        xyz2 = [x2, y2, z2, ones(size(x2))];    % æ„é€ é½æ¬¡åæ ‡
        %   æ„é€ åæ ‡å˜æ¢ï¼ˆå…ˆå¹³ç§»å†æ—‹è½¬ï¼‰
        t1 = trans_matrix([([0 0 0]-vect3(j,1:3)),0,0,0],1);  % å…ˆç§»åŠ¨åˆ°[0 0 0]
        [pos_sph1(1),pos_sph1(2)] = cart2sph(vect3(j,4),vect3(j,5),vect3(j,6));   %   åˆ†é‡è½¬ä¸ºæ—‹è½¬
        [pos_sph2(1),pos_sph2(2)] = cart2sph(0,0,1);                        %   åˆ†äº«è½¬ä¸ºæ—‹è½¬
        pos_sph1 = rad2deg(pos_sph1); pos_sph2 = rad2deg(pos_sph2);         %   è½¬ä¸ºè§’åº¦åˆ¶
        t2 = trans_matrix([0,0,0,0,-pos_sph1(2),-pos_sph1(1)],1);
        t3 = trans_matrix([0,0,0,0,-90,-90],1);
        t = t3*t2*t1;
        xyz3 = (t*xyz2')';                      % åšçº¿æ€§å˜æ¢
        xyz3 = sortrows(xyz3,1);                % å¯¹ç»“æœåš
        x3 = xyz3(:,1); y3 = xyz3(:,2); z3 = xyz3(:,3);                     % å°†åæ ‡å˜æ¢åˆ°XOYå¹³é¢ä¸Š
        %   æå–æˆªé¢ä¿¡æ¯
        % x4 = x3(y3>=zreg);
        % y4 = y3(y3>=zreg);
        p=0.9999;
        pp = csaps(x3,y3,p);                %   Create piecewise function coefficients
        ff = fittype('smoothingspline');    %   Create fittype object
        cf = cfit(ff,pp);                   %   Create cfit object
        yf = cf(x3);
        %   è®¡ç®—å½“å‰ä¸­å¿ƒçº¿å¯¹åº”çš„çº¿æ¡æˆªé¢èŒƒå›´
        pos1=find(x3<=0&yf<=zreg,1,'last');
        pos2=find(x3>=0&yf<=zreg,1,'first');
        %   è®¡ç®—çº¿å®½çº¿é«˜
        x4 = x3(pos1:pos2);
        y4 = yf(pos1:pos2);
        sw = max(x4)-min(x4);
        sh = max(y4)-min(y4);
        %   æ‹Ÿåˆä¸ä¿å­˜
        obj.LS_profile(m).sn=m;
        obj.LS_profile(m).group=i;
        obj.LS_profile(m).seria=j;
        obj.LS_profile(m).act=1;
        obj.LS_profile(m).x=vect3(j,1);
        obj.LS_profile(m).y=vect3(j,2);
        obj.LS_profile(m).z=vect3(j,3);
        obj.LS_profile(m).i=vect3(j,4);
        obj.LS_profile(m).j=vect3(j,5);
        obj.LS_profile(m).k=vect3(j,6);
        obj.LS_profile(m).s=scurve(j);
        obj.LS_profile(m).ss=ts;
        % obj.LS_profile(m).edge=[min(x3),max(x3),min(y3),max(y3),min(z3),max(z3)];
        % obj.LS_profile(m).xx = x3;
        % obj.LS_profile(m).yy = y3;
        obj.LS_profile(m).edge=[min(x4),max(x4),min(y4),max(y4),min(z3),max(z3)];
        obj.LS_profile(m).xx = x4;
        obj.LS_profile(m).yy = y4;
        obj.LS_profile(m).sw = sw;
        obj.LS_profile(m).sh = sh;
        switch fit_mode
            case 1
                obj.LS_profile(m).curve_cmd = 'csaps(xx,yy,0.98,xx);';
        end
        % obj.LS_profile(m).curve = cp_extract_cspline(x3,smooth(y3,0.8),0.92,'kk',0.1,'k1',0.5,'k2',1);
        if test
            figure(2)
            xx = obj.LS_profile(m).xx;
            yy = obj.LS_profile(m).yy;
            switch fit_mode
                case 1
                    fy = eval(obj.LS_profile(m).curve_cmd);
            plot(x3,y3,'.k',x3,fy,'r-');
            tt = ['group ',num2str(i,'%02i'),', num ',num2str(j,'%03i'),' [',num2str(vect3(j,1),'%03.2f'),',',num2str(vect3(j,2),'%03.2f'),']'];
            title(tt)
            xlabel('n [mm]') % æ³•çº¿è½´
            ylabel('b [mm]') % å‰¯æ³•çº¿è½´
            set(gca,'FontName','Times New Roman')
            if save_flag
                saveas(gca,[obj.syset.path_outfig,'profile_g',num2str(i,'%03i'),'_n',num2str(j,'%03i'),'.jpg'])
            end
            if debug
                figure(1)
                mesh(xx,yy,zz)
                figure(2)
                plot3(x2,y2,z2,'r.',x3,y3,z3,'b.');
                view([0 0 1])
            end
        end
        m=m+1;
    end
end
%%  ç»“æŸä¸æ ‡è®°
obj.syset.flags.read_flag_profiletxra = 1;
end